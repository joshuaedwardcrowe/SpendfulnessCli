using SpendfulnessCli.Aggregation.Calculators;
using SpendfulnessCli.Aggregation.Aggregates;
using Ynab;
using Ynab.Extensions;

namespace SpendfulnessCli.Aggregation.Aggregator.ListAggregators;

public class TransactionMonthTotalListAggregator(IEnumerable<Transaction> transactions)
    : YnabListAggregator<TransactionMonthTotalAggregate>(transactions)
{
    protected override IEnumerable<TransactionMonthTotalAggregate> GenerateAggregate()
    {
        var transactionsGroupedByMonth = Transactions
            .GroupByMonth()
            .ToList();
        
        for (var i = 0; i < transactionsGroupedByMonth.Count; i++)
        {
            // 1, 1, 2, 3, 4
            var priorIndex = i > 0 ? i - 1 : 0;
            
            var priorAverage = transactionsGroupedByMonth[priorIndex]
                .Transactions
                .Sum(x => x.Amount);

            var currentAverage = transactionsGroupedByMonth[i]
                .Transactions.Sum(m => m.Amount);
            
            var percentageChange = PercentageCalculator.CalculateChange(priorAverage, currentAverage);
            
            yield return new TransactionMonthTotalAggregate(
                transactionsGroupedByMonth[i].Month, 
                currentAverage,
                percentageChange);
        }
    }
}